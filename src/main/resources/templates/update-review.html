<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동행 후기 수정</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/styles2.css">
    <link rel="stylesheet" href="/static/css/reviews.css">
    <script>
        // accessToken 불러오기
        let accessToken = localStorage.getItem('accessToken');
        const boardId = window.location.pathname.split("/")[2];
        const reviewId = window.location.pathname.split("/")[4];

        document.addEventListener('DOMContentLoaded', function () {
            const updateForm = document.getElementById('updateForm');
            const updateButton = document.getElementById('updateButton');

            updateButton.addEventListener("click", function (event) {
                event.preventDefault();
                const formData = new FormData(updateForm);
                const jsonData = JSON.stringify(Object.fromEntries(formData.entries()));
                console.log(jsonData);

                if (confirm("게시물을 수정하시겠습니까?")) {
                    fetch(`/boards/${boardId}/reviews/sender/${reviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(Object.fromEntries(formData.entries()))
                    })
                        .then(response => {
                            if (response.ok) {
                                alert("후기가 수정되었습니다.");
                                window.location.href = `/`;
                            } else {
                                alert("후기 수정에 실패했습니다.");
                            }
                        })
                        .catch(error => {
                            console.error('Network error:', error);
                        });
                } else {
                    alert("후기 수정이 취소되었습니다.");
                }
            });
        });
    </script>
</head>
<body>
<th:block layout:fragment="content">
<div class="content">
    <h2>동행 후기 수정</h2>
    <div class="original-board">
        <a class="href-none" href="#">
            <span class="original-left">
                <p><img src="/static/images/user-profile1.jpg" alt="원글 작성자 프로필 사진"></p>
            </span>
            <span class="original-right">
                <span class="original-right-top" th:text="${board.title}">
                    원글 제목
                </span>
                <br>
                <span class="original-right-bottom">
                    <span th:text="${board.username}" >원글 작성자</span>
                    <span>·</span>
                    <span th:text="${board.country}">여행지</span>
                </span>
            </span>
        </a>
    </div>
    <br>
    <form th:action="@{'/boards/' + ${boardId} + '/reviews/sender/' + ${id}}" th:method="put" id="updateForm">
        <div class="rating">
            <h4>여행은 어떠셨나요 ?</h4>
            <span>별로였어요</span>
            <br>
            <input type="range" class="form-range" id="customRange1" min="1" max="5" step=0.5 th:value="${review.rating}" onchange="range_change(this)">
            <input type="text" id="rating" name="rating" th:value="${review.rating}">
            <script>
                function range_change(obj) {
                    document.getElementById('rating').value=obj.value;
                    console.log(document.getElementById('rating'));
                }
            </script>
            <br>
            <span>좋았어요 !</span>
        </div>
        <br>
        <div>
            <h4>후기를 남겨주세요</h4>
            <div class="mb-3 review-board-update">
                <textarea th:text="${review.content}" class="review-content" id="exampleFormControlTextarea1" name="content" rows="7" cols="92">수정 전 작성한 후기가 보여집니다.</textarea>
            </div>
            <div class="form-button">
                <button type="submit" class="btn btn-light" id="updateButton">등록</button>
                <button type="button" class="btn btn-secondary">취소</button>
            </div>
        </div>
    </form>
</div>
</th:block>
</body>
</html>